<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo Digital</title>
    <link rel="icon" href="img/favicon.webp" type="image/x-icon">
    <!-- StPageFlip Librería para el efecto de pasar página -->
    <script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.js"></script>
    <!-- PDF.js (Librería para leer el PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- FontAwesome para iconos (opcional, pero mejora la estética) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/estilos.css">

</head>

<body>

    <div id="loader">Cargando catálogo...</div>

    <div class="book-wrapper">
        <!-- Mensaje de Bienvenida -->
        <div id="welcome-msg" class="welcome-message">
            <h1>Bienvenido</h1>
            <p>Descubre nuestra colección exclusiva MC Nails. Desliza las páginas o usa las flechas para explorar el catálogo.</p>
            <div class="arrow-hint">
                Explorar <i class="fas fa-arrow-right"></i>
            </div>
        </div>

        <!-- Flechas Laterales -->
        <button class="nav-arrow prev-btn" onclick="prevPage()"><i class="fas fa-chevron-left"></i></button>
        <button class="nav-arrow next-btn" onclick="nextPage()"><i class="fas fa-chevron-right"></i></button>

        <!-- Contenedor del Libro -->
        <div id="flip-book" class="flip-book">
            <!-- Las páginas se generarán dinámicamente aquí -->
        </div>
    </div>

    <!-- Barra de Controles Inferior -->
    <div class="controls">
        <button class="btn" onclick="prevPage()"><i class="fas fa-chevron-left"></i></button>
        <span class="page-info" id="page-count">0 / 0</span>
        <button class="btn" onclick="nextPage()"><i class="fas fa-chevron-right"></i></button>

        <!-- Botones de Zoom -->
        <button class="btn" onclick="resetZoom()" id="zoom-reset-btn" title="Regresar al tamaño normal"><i class="fas fa-search-minus"></i></button>
        <button class="btn" onclick="toggleZoom()" title="Aumentar zoom"><i class="fas fa-search-plus"></i></button>
    </div>

    <script>
        // Configuración de PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const pdfUrl = 'catalogo.pdf';
        let pageFlip;
        let pdfDoc = null;
        let zoomLevel = 1; // Cambiado de isZoomed a zoomLevel numérico

        // Cargar el documento PDF
        async function loadBook() {
            try {
                document.getElementById('loader').innerText = 'Cargando PDF...';

                const loadingTask = pdfjsLib.getDocument(pdfUrl);
                pdfDoc = await loadingTask.promise;

                const totalPages = pdfDoc.numPages;
                document.getElementById('loader').innerHTML = `PDF cargado: ${totalPages} páginas<br>Preparando vista...`;

                const bookContainer = document.getElementById('flip-book');
                bookContainer.innerHTML = '';

                // Crear contenedores para todas las páginas
                for (let i = 1; i <= totalPages; i++) {
                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'page';
                    if (i === 1 || i === totalPages) {
                        pageDiv.setAttribute('data-density', 'hard');
                    } else {
                        pageDiv.setAttribute('data-density', 'soft');
                    }

                    pageDiv.innerHTML = `<canvas id="canvas-${i}"></canvas>`;
                    bookContainer.appendChild(pageDiv);
                }

                // Renderizar solo las primeras 6 páginas para iniciar rápido
                document.getElementById('loader').innerHTML = `Renderizando primeras páginas...`;

                const initialPages = Math.min(6, totalPages);
                for (let i = 1; i <= initialPages; i++) {
                    await renderPage(i);
                }

                // Inicializar el flipbook
                document.getElementById('loader').innerHTML = `Inicializando visor...`;
                initFlipBook();

                // Renderizar el resto de páginas en segundo plano
                if (totalPages > initialPages) {
                    renderRemainingPages(initialPages + 1, totalPages);
                }

            } catch (error) {
                console.error('Error al cargar el PDF:', error);
                document.getElementById('loader').innerHTML = `<span style="color: #ff6b6b;">Error: ${error.message}</span><br>Verifica que el archivo exista`;
            }
        }

        // Renderizar páginas restantes en background
        async function renderRemainingPages(start, end) {
            for (let i = start; i <= end; i++) {
                await renderPage(i);
                // Pequeña pausa para no bloquear la UI
                if (i % 5 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }
            console.log('Todas las páginas renderizadas');
        }

        // Renderizar una página específica del PDF en su Canvas
        async function renderPage(num) {
            try {
                const page = await pdfDoc.getPage(num);
                const canvas = document.getElementById(`canvas-${num}`);
                if (!canvas) return;

                const ctx = canvas.getContext('2d');

                // Escala alta para máxima calidad de texto (3x para textos pequeños nítidos)
                const viewport = page.getViewport({ scale: 3.0 });

                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // Mejorar calidad de renderizado del texto
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };

                await page.render(renderContext).promise;
            } catch (e) {
                console.warn(`Error renderizando página ${num}:`, e);
            }
        }

        // Configuración del FlipBook
        async function initFlipBook() {
            try {
                // Obtener las dimensiones reales de una página del PDF
                const firstPage = await pdfDoc.getPage(1);
                const viewport = firstPage.getViewport({ scale: 1 });
                const pdfAspectRatio = viewport.width / viewport.height;

                console.log(`PDF aspect ratio: ${pdfAspectRatio.toFixed(3)} (${viewport.width}x${viewport.height})`);

                // Usar dimensiones de ventana directamente - 100% de la pantalla
                const availableHeight = window.innerHeight; // 100% altura - controles se superponen
                const availableWidth = window.innerWidth; // 100% ancho

                // Detectar si es dispositivo móvil por ancho de pantalla
                const isMobile = availableWidth < 768;

                let pageHeight, pageWidth;

                if (isMobile) {
                    // MÓVIL: Probar ambas estrategias y elegir la que da páginas más grandes

                    // Opción 1: Maximizar por altura
                    let h1 = availableHeight;
                    let w1 = h1 * pdfAspectRatio;

                    // Opción 2: Maximizar por ancho
                    let w2 = availableWidth;
                    let h2 = w2 / pdfAspectRatio;

                    // Elegir la opción que cabe y da mayor área
                    if (w1 <= availableWidth && h1 <= availableHeight) {
                        pageWidth = w1;
                        pageHeight = h1;
                    } else if (w2 <= availableWidth && h2 <= availableHeight) {
                        pageWidth = w2;
                        pageHeight = h2;
                    } else {
                        // Ninguna cabe perfectamente, usar la más pequeña
                        pageWidth = Math.min(w1, availableWidth);
                        pageHeight = pageWidth / pdfAspectRatio;
                    }
                } else {
                    // DESKTOP (2 páginas): Probar ambas estrategias

                    // Opción 1: Maximizar por altura
                    let h1 = availableHeight;
                    let w1 = h1 * pdfAspectRatio;

                    // Opción 2: Maximizar por ancho (dividido entre 2 páginas)
                    let w2 = availableWidth / 2;
                    let h2 = w2 / pdfAspectRatio;

                    // Elegir la opción que da páginas más grandes
                    if (w1 * 2 <= availableWidth) {
                        // La opción por altura cabe perfectamente
                        pageWidth = w1;
                        pageHeight = h1;
                    } else {
                        // Usar la opción por ancho
                        pageWidth = w2;
                        pageHeight = h2;
                    }
                }

                // Redondear para evitar problemas de renderizado
                pageWidth = Math.round(pageWidth);
                pageHeight = Math.round(pageHeight);

                console.log(`Modo: ${isMobile ? 'Móvil (1 página)' : 'Desktop (2 páginas)'} - ${pageWidth}x${pageHeight} px`);
                console.log(`Uso de pantalla: ${isMobile ? pageWidth : pageWidth * 2}px de ${availableWidth}px ancho (${Math.round((isMobile ? pageWidth : pageWidth * 2) / availableWidth * 100)}%), ${pageHeight}px de ${availableHeight}px alto (${Math.round(pageHeight / availableHeight * 100)}%)`);

                pageFlip = new St.PageFlip(document.getElementById('flip-book'), {
                    width: Math.round(pageWidth),
                    height: Math.round(pageHeight),
                    size: 'fixed',
                    minWidth: 200,
                    maxWidth: 8000,
                    minHeight: 200,
                    maxHeight: 8000,
                    maxShadowOpacity: 0.5,
                    showCover: true,
                    mobileScrollSupport: false,
                    usePortrait: isMobile,
                    drawShadow: true,
                    flippingTime: 400, // Tiempo de animación en ms (por defecto suele ser 1000)
                    swipeDistance: 30,  // Distancia mínima de swipe para pasar página
                    useMouseEvents: true
                });

                pageFlip.loadFromHTML(document.querySelectorAll('.page'));

                pageFlip.on('flip', (e) => {
                    updatePageInfo();
                    // Ocultar mensaje de bienvenida al pasar la página
                    const welcomeMsg = document.getElementById('welcome-msg');
                    if (welcomeMsg && e.data > 0) {
                        welcomeMsg.classList.remove('visible');
                    } else if (welcomeMsg && e.data === 0) {
                        welcomeMsg.classList.add('visible');
                    }
                });

                // Mostrar el libro
                document.getElementById('loader').style.display = 'none';
                document.getElementById('flip-book').style.display = 'block';

                // Mostrar mensaje inicial si estamos en la página 0
                const welcomeMsg = document.getElementById('welcome-msg');
                if (welcomeMsg) welcomeMsg.classList.add('visible');

                updatePageInfo();
                updateZoomButtonStates(); // Inicializar estado de botones de zoom
            } catch (error) {
                console.error('Error inicializando flipbook:', error);
                document.getElementById('loader').innerHTML = `<span style="color: #ff6b6b;">Error al inicializar: ${error.message}</span>`;
            }
        }

        // Funciones de control
        function prevPage() {
            if (pageFlip) pageFlip.flipPrev();
        }

        function nextPage() {
            if (pageFlip) pageFlip.flipNext();
        }

        function updatePageInfo() {
            if (!pageFlip) return;
            const current = pageFlip.getCurrentPageIndex() + 1;
            const total = pageFlip.getPageCount();
            document.getElementById('page-count').innerText = `${current} / ${total}`;
        }

        function updateZoomButtonStates() {
            const resetBtn = document.getElementById('zoom-reset-btn');
            // Deshabilitar el botón de reset si estamos en 1x (tamaño normal)
            if (zoomLevel <= 1) {
                resetBtn.style.opacity = '0.3';
                resetBtn.style.cursor = 'not-allowed';
                resetBtn.style.pointerEvents = 'none';
            } else {
                resetBtn.style.opacity = '1';
                resetBtn.style.cursor = 'pointer';
                resetBtn.style.pointerEvents = 'auto';
            }
        }

        function resetZoom() {
            // Solo permitir reset si estamos con zoom aplicado
            if (zoomLevel <= 1) return;

            const book = document.getElementById('flip-book');

            // Regresar directamente a 1x (tamaño normal)
            zoomLevel = 1;

            book.style.transform = `scale(${zoomLevel})`;
            book.style.transformOrigin = 'center center';

            // Mostrar mensaje temporalmente
            const pageInfo = document.getElementById('page-count');
            pageInfo.innerText = `Zoom: 100% (Normal)`;
            setTimeout(() => {
                updatePageInfo();
            }, 1000);

            updateZoomButtonStates();
        }

        function toggleZoom() {
            const book = document.getElementById('flip-book');

            // Incrementar niveles de zoom: 1x -> 1.5x -> 2x -> 2.5x
            if (zoomLevel === 1) {
                zoomLevel = 1.5;
            } else if (zoomLevel === 1.5) {
                zoomLevel = 2;
            } else if (zoomLevel === 2) {
                zoomLevel = 2.5;
            } else {
                // Si ya estamos en 2.5x o más, no incrementamos más
                return;
            }

            book.style.transform = `scale(${zoomLevel})`;
            book.style.transformOrigin = 'center center'; // Zoom desde el centro

            // Mostrar nivel de zoom temporalmente
            const pageInfo = document.getElementById('page-count');
            pageInfo.innerText = `Zoom: ${Math.round(zoomLevel * 100)}%`;
            setTimeout(() => {
                updatePageInfo();
            }, 1000);

            updateZoomButtonStates();
        }

        // Iniciar todo
        loadBook();

    </script>
</body>

</html>